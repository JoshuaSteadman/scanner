<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steadman's Checkin Tool</title>
    <style>
    @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css');

    /* General styles */
    body {
        font-family: Arial, sans-serif;
    }

    /* Table styles */
    table {
        table-layout: auto;
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
        border: 1px solid #ddd;
        padding: 8px;
    }

    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }

    /* Sortable header styles */
    .sortable:hover {
        cursor: pointer;
        background-color: #e6e6e6;
    }

    /* Multi-select dropdown styles */
    .multi-select-dropdown {
        position: relative;
        display: inline-block;
    }

    .multi-select-dropdown-content {
        display: none;
        position: absolute;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
        max-height: 300px;
        overflow-y: auto;
    }

    .multi-select-dropdown-content label {
        display: block;
        padding: 5px;
    }

    .multi-select-dropdown-content label:hover {
        background-color: #f1f1f1;
    }

    .show {
        display: block;
    }

    /* APN lookup styles */
    .apn-lookup {
        cursor: pointer;
    }

    .apn-lookup:hover {
        text-decoration: underline;
    }

    /* Hidden column styles */
    .hidden-column {
        display: none;
    }

    /* File input wrapper styles */
    .file-input-wrapper {
        position: relative;
        display: inline-block;
        margin-right: 10px;
    }

    .file-input-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    /* File input button styles */
    .file-input-button {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.3s, box-shadow 0.3s;
    }

    .file-input-button:hover {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .file-input-button i {
        margin-right: 0.5rem;
    }

    /* CSV button styles */
    .csv-button {
        background-color: #4CAF50;
        color: white;
        border: 1px solid #45a049;
    }

    .csv-button:hover {
        background-color: #45a049;
    }

    /* PSV button styles */
    .psv-button {
        background-color: #2196F3;
        color: white;
        border: 1px solid #1e88e5;
    }

    .psv-button:hover {
        background-color: #1e88e5;
    }
   .truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
	}
    .description-input {
        font-size: inherit;
        font-family: inherit;
        width: 100%;
        padding: 0;
        border: none;
        background: transparent;
    }


    /* Other button styles */
    button {
        padding: 0.5rem 1rem;
        margin-right: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 0.25rem;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    button:hover {
        background-color: #e9ecef;
    }

    /* Row color styles */
    .bg-yellow-200 { background-color: #fefcbf; }
    .bg-green-200 { background-color: #c6f6d5; }
    .bg-yellow-300 { background-color: #faf089; }
    .bg-red-200 { background-color: #fed7d7; }
    .bg-orange-200 { background-color: #feebc8; }
    .bg-blue-200 { background-color: #bee3f8; }

    /* Floating controls styles */
    #floatingControls {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: #f8f9fa;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        z-index: 1000;
        transition: transform 0.3s ease-in-out;
    }

    #floatingControls.hidden {
        transform: translateY(-100%);
    }
#toggleControlsBtn {
    position: fixed;
    bottom: 10px;
    left: 10px;
    z-index: 1001;
    padding: 5px 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    background: transparent;
    color: red;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

#toggleControlsBtn:hover {
    background-color: #0056b3;
}

    /* Print styles */
    @media print {
        #floatingControls, #toggleControlsBtn {
            display: none !important;
        }
    }
    </style>
</head>
<body class="p-4">
    <div id="floatingControls">
        <div class="mb-4 flex space-x-2">
            <div class="file-input-wrapper">
                <input type="file" accept=".csv" id="csvFileInput" class="mb-4">
                <span class="file-input-button">Choose CSV</span>
            </div>
            <div class="multi-select-dropdown">
                <button onclick="toggleDropdown()" class="p-2 border rounded">Select Routes</button>
                <div id="routeDropdown" class="multi-select-dropdown-content">
                    <!-- Route checkboxes will be dynamically added here -->
                </div>
            </div>
            <button onclick="toggleProcessingDeliveryRows()" class="p-2 border rounded" id="toggleProcessingBtn">Hide "Processing w/Paper"</button>
            <button onclick="copyAllAPNLookups()" class="p-2 border rounded">Copy All APN</button>
            <button onclick="bulkEnterDescriptions()" class="p-2 border rounded">Bulk Enter Desc</button>
            <button onclick="copyAllDescriptions()" class="p-2 border rounded">Copy Column Desc</button>
            <button onclick="toggleColumnVisibility()" class="p-2 border rounded">Toggle Column Visibility</button>
            <button onclick="toggleLocalDrivers()" class="p-2 border rounded" id="toggleLocalDriversBtn">Hide Local Drivers</button>
            <button onclick="invertRouteSelection()" class="p-2 border rounded">Invert Route Selection</button>
            <div class="file-input-wrapper">
                <input type="file" accept=".psv" id="psvFileInput" class="mb-4">
                <span class="file-input-button">Choose PSV</span>
            </div>
        </div>
    </div>
    <button id="toggleControlsBtn" onclick="toggleControls()">Show</button>
    <div id="tableContainer" class="overflow-x-auto"></div>

<script>
let csvData = { headers: [], data: [] };
let sortColumns = [
    { column: 'Route', direction: 'asc' },
    { column: 'Reason', direction: 'asc' }
];
let selectedRoutes = new Set();
let apnDescriptions = {};
let hideProcessingDelivery = false;
let hiddenColumns = new Set();
let hideLocalDrivers = false;
let localDrivers = new Set([
    "James, John",
    "Evola, Lewis",
    "Rosario, Thomas",
    "Gerena, Edgardo",
    "Veras De Los Santos, Jeremy",
    "Miranda, Kevin",
    "Gomes, Brian",
    "Jordan, Justin",
    "Griffin, David",
    "McKnight, Anthony",
    "Mcknight, Anthony",
    "Reynolds, Oshane",
    "Longley, Michael",
    "Luna, Lenn",
    "Archambault, Aaro",
    "Fishman, Andrew",
    "Diaz, Juan",
    "Ramirez, Christian",
    "Hyslop, Michael",
    "Claiborne, John",
    "Diaz-Heredia, Ramser",
    "Jones, General",
    "Thomas, Calvin",
    "Smith, Troy",
    "Anguita, Estefano",
    "Jeffers, Justin",
    "Lugo, Abner",
    "Hunt, Gary",
    "Joseph, Dwayne",
    "Gendron, Harold",
    "Butler, Naseem",
    "Ramos, April",
    "Spence, Shane",
    "Archambault, Aaron",
    "Luna, Lenny",
    "Fishman, Ryan",
    "Sanderson, Sean",
    "Robbins, David"
]);

function toggleLocalDrivers() {
    hideLocalDrivers = !hideLocalDrivers;
    const btn = document.getElementById('toggleLocalDriversBtn');
    btn.textContent = hideLocalDrivers ? 'Show Local Drivers' : 'Hide Local Drivers';

    if (hideLocalDrivers) {
        csvData.data.forEach(row => {
            if (isLocalDriver(row['Driver'])) {
                selectedRoutes.delete(row['Route']);
            }
        });
    }

    updateRouteCheckboxes();
    renderTable();
}

function copyAllDescriptions() {
    const visibleData = getFilteredAndSortedData();
    const descriptions = visibleData.map((row, index) => {
        // Use the row index to get the correct description
        return apnDescriptions[index] || '';
    }).filter(desc => desc !== '').join('\n');
    
    if (descriptions) {
        navigator.clipboard.writeText(descriptions)
            .then(() => console.log('Descriptions copied successfully'))
            .catch(err => console.error('Failed to copy descriptions: ', err));
    } else {
        console.log('No descriptions to copy');
    }
}

function invertRouteSelection() {
    const allRoutes = new Set(csvData.data.map(row => row['Route']));
    
    allRoutes.forEach(route => {
        if (selectedRoutes.has(route)) {
            selectedRoutes.delete(route);
        } else {
            selectedRoutes.add(route);
        }
    });

    if (hideLocalDrivers) {
        hideLocalDrivers = false;
        document.getElementById('toggleLocalDriversBtn').textContent = 'Hide Local Drivers';
    }

    updateRouteCheckboxes();
    renderTable();
}

function parseCSV(text) {
    console.log("Parsing CSV...");
    const lines = text.split('\n').filter(line => line.trim() !== '');
    const originalHeaders = lines[0].split(',').map(header => header.trim());
    
    const headerMap = {
        'Order Number': 'Order #',
        'Customer Number': 'Cust. #',
        'Customer Name': 'Cust. Name',
        'Route': 'Route',
        'Reason Code': 'Reason',
        'Purpose': 'Purpose',
        'Item ID': 'Item ID',
        'Qty (Exc / Tot)': 'Qty',
        'Driver Name': 'Driver',
        'Date': 'Date',
        'APN Lookup': 'APN',
        'APN Description': 'APN Desc.'
    };

    const headers = originalHeaders.map(header => headerMap[header] || header);
    console.log(`Shortened Headers: ${headers.join(', ')}`);
    
    const data = lines.slice(1).map(line => {
        const values = [];
        let inQuotes = false;
        let currentValue = '';
        
        for (let char of line) {
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                values.push(currentValue.trim());
                currentValue = '';
            } else {
                currentValue += char;
            }
        }
        values.push(currentValue.trim());
        
        const row = headers.reduce((obj, header, index) => {
            let value = values[index] || '';
            // Remove (EDT) from the Date column
            if (header === 'Date') {
                value = value.replace(' (EDT)', '');
            }
            // Remove " - FIXED" from the Purpose column
            if (header === 'Purpose') {
                value = value.replace(' - FIXED', '');
            }
            obj[header] = value;
            return obj;
        }, {});

        if (row['Order #']) {
            row['Order #'] = row['Order #'].substring(0, 7);
        }

        if (row['Item ID']) {
            const itemId = row['Item ID'];
            const len = itemId.length;
            const boldStart = Math.max(0, len - 10);
            const boldEnd = Math.max(0, len - 3);
            row['Item ID'] = 
                itemId.substring(0, boldStart) + 
                '<strong>' + itemId.substring(boldStart, boldEnd) + '</strong>' + 
                itemId.substring(boldEnd);
            
            row['APN'] = itemId.substring(boldStart, boldEnd);
        }

        if (row['Qty']) {
            const [exc, tot] = row['Qty'].split('/').map(v => parseInt(v.trim()) || 0);
            row['Quantity'] = { exc, tot };
        }

        return row;
    });

    console.log(`Parsed ${data.length} rows`);
    headers.push('APN Desc.');

    return { headers, data: mergeRows(data) };
}
function mergeRows(data) {
    console.log("Merging rows...");
    const mergedData = {};
    data.forEach(row => {
        const key = `${row['Order #']}-${row['APN']}-${row['Reason']}`;
        if (mergedData[key]) {
            mergedData[key]['Quantity'].exc += row['Quantity'].exc;
            mergedData[key]['Quantity'].tot += row['Quantity'].tot;
        } else {
            mergedData[key] = { ...row };
        }
    });

    const result = Object.values(mergedData).map(row => ({
        ...row,
        'Qty': `${row['Quantity'].exc} / ${row['Quantity'].tot}`
    }));
    console.log(`Merged to ${result.length} rows`);
    return result;
}

function handleCSVFileUpload(event) {
    console.log("CSV file upload started");
    const file = event.target.files[0];
    if (!file) {
        console.log('No CSV file selected.');
        return;
    }
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please select a CSV file.');
        event.target.value = ''; // Clear the file input
        return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
        const text = e.target.result;
        csvData = parseCSV(text);
        populateRouteDropdown();
        apnDescriptions = {};
        renderTable();
    };
    reader.readAsText(file);
}

// Modify the processPSVData function to include more logging
function processPSVData(text) {
    console.log("Processing PSV data...");
    const lines = text.split('\n');
    const headers = lines[0].split('|');
    const productDescriptionIndex = headers.findIndex(header => header.trim().startsWith('Product Description USF'));
    const productDescriptionLaptopIndex = headers.findIndex(header => header.trim().startsWith('Product Description Laptop'));

    console.log(`Product Description USF index: ${productDescriptionIndex}`);
    console.log(`Product Description Laptop index: ${productDescriptionLaptopIndex}`);

    if (productDescriptionIndex === -1 && productDescriptionLaptopIndex === -1) {
        console.log('Required columns not found in PSV file.');
        return;
    }

    // Reset apnDescriptions to store by row number
    apnDescriptions = {};

    lines.slice(1).forEach((line, index) => {
        const values = line.split('|');
        if (values.length > Math.max(productDescriptionIndex, productDescriptionLaptopIndex)) {
            const description = values[productDescriptionIndex]?.trim() || values[productDescriptionLaptopIndex]?.trim() || '';
            if (description) {
                apnDescriptions[index] = description;
            }
        }
    });

    console.log(`PSV processing complete. Processed ${Object.keys(apnDescriptions).length} descriptions.`);
    console.log("Sample of processed descriptions:", Object.entries(apnDescriptions).slice(0, 5));
    renderTable();
}


function populateRouteDropdown() {
    console.log("Populating route dropdown");
    const dropdown = document.getElementById('routeDropdown');
    const uniqueRoutes = [...new Set(csvData.data.map(row => row['Route']))];
    
    uniqueRoutes.sort((a, b) => a.localeCompare(b));
    
    dropdown.innerHTML = uniqueRoutes.map(route => 
        `<label><input type="checkbox" value="${route}" onchange="handleRouteSelection(this)" checked> ${route}</label>`
    ).join('');

    selectedRoutes = new Set(uniqueRoutes);
}

function handleRouteSelection(checkbox) {
    if (checkbox.checked) {
        selectedRoutes.add(checkbox.value);
    } else {
        selectedRoutes.delete(checkbox.value);
    }
    renderTable();
}

function toggleDropdown() {
    document.getElementById("routeDropdown").classList.toggle("show");
}

function toggleProcessingDeliveryRows() {
    hideProcessingDelivery = !hideProcessingDelivery;
    const btn = document.getElementById('toggleProcessingBtn');
    btn.textContent = hideProcessingDelivery ? 'Show "Processing w/Paper"' : 'Hide "Processing w/Paper"';
    renderTable();
}

function copyAllAPNLookups() {
    const visibleData = getFilteredAndSortedData();
    const apnLookups = visibleData.map(row => row['APN']).join('\n');
    navigator.clipboard.writeText(apnLookups).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

// In bulkEnterDescriptions function
function bulkEnterDescriptions() {
    navigator.clipboard.readText().then(text => {
        const lines = text.split('\n');
        const visibleData = getFilteredAndSortedData();
        visibleData.forEach((row, index) => {
            if (index < lines.length) {
                const description = lines[index].trim();
                apnDescriptions[index] = description;
            }
        });
        renderTable();
    }).catch(err => {
        console.error('Failed to read clipboard: ', err);
    });
}

function handleSort(column) {
    const existingSort = sortColumns.find(sc => sc.column === column);
    if (existingSort) {
        existingSort.direction = existingSort.direction === 'asc' ? 'desc' : 'asc';
        sortColumns = [existingSort, ...sortColumns.filter(sc => sc.column !== column)];
    } else {
        sortColumns.unshift({ column, direction: 'asc' });
    }
    sortColumns = sortColumns.slice(0, 2);  // Keep only the top two sort criteria
    renderTable();
}

function getRowColor(row) {
    const reasonCode = row['Reason'];
    const purpose = row['Purpose'];

    if (reasonCode === '01 Truck Short') return 'bg-yellow-200';
    if (reasonCode.startsWith('13 Reclaim')) return 'bg-green-200';
    if (reasonCode.startsWith('04')) return 'bg-yellow-300';
    if (reasonCode === '10 Spoiled Product' || reasonCode.startsWith('03')) return 'bg-red-200';
    if (reasonCode.startsWith('99P Pick Up Not A')) return 'bg-orange-200';
    if (purpose && purpose.toLowerCase().includes('frozen') && !reasonCode.startsWith('01')) return 'bg-blue-200';
    return '';
}

function getFilteredAndSortedData() {
    console.log("Filtering and sorting data");
    return csvData.data
        .filter(row => {
            const routeCondition = selectedRoutes.has(row['Route']);
            const processingCondition = !hideProcessingDelivery || row['Reason'] !== '40 Processing Delivery on paper';
            const driverCondition = !hideLocalDrivers || !isLocalDriver(row['Driver']);
            return routeCondition && processingCondition && driverCondition;
        })
        .sort((a, b) => {
            for (const { column, direction } of sortColumns) {
                if (a[column] < b[column]) return direction === 'asc' ? -1 : 1;
                if (a[column] > b[column]) return direction === 'asc' ? 1 : -1;
            }
            return 0;
        });
}

function toggleColumnVisibility() {
    const columnsToToggle = ['Date', 'Cust. Name', 'APN', 'Driver', 'Item ID'];
    columnsToToggle.forEach(column => {
        if (hiddenColumns.has(column)) {
            hiddenColumns.delete(column);
        } else {
            hiddenColumns.add(column);
        }
    });
    renderTable();
}

function getColumnWidth(header) {
    switch (header) {
        case 'Order #': return '80px';
        case 'Cust. #': return '80px';
        case 'Cust. Name': return '120px';  // Changed from 150px to 120px
        case 'Route': return '60px';
        case 'Reason': return '100px';  // Changed from 120px to 100px
        case 'Purpose': return '100px';
        case 'Item ID': return '120px';
        case 'Qty': return '80px';
        case 'Driver': return '100px';
        case 'Date': return '80px';
        case 'APN': return '100px';
        case 'APN Desc.': return '120px';
        default: return 'auto';
    }
}

function handleDriverClick(driverName, route) {
    if (selectedRoutes.has(route)) {
        selectedRoutes.delete(route);
        const checkbox = document.querySelector(`#routeDropdown input[value="${route}"]`);
        if (checkbox) {
            checkbox.checked = false;
        }
        renderTable();
    }
}

function updateRouteCheckboxes() {
    const checkboxes = document.querySelectorAll('#routeDropdown input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectedRoutes.has(checkbox.value);
    });
}
// Modify the renderTable function to include more logging limited width of column update
function renderTable() {
    console.log("Rendering table");
    const tableContainer = document.getElementById('tableContainer');
    const filteredAndSortedData = getFilteredAndSortedData();
    console.log(`Rendering ${filteredAndSortedData.length} rows`);

    let tableHTML = '<table class="border-collapse">';
    
    // Render headers
    tableHTML += '<thead><tr>';
    csvData.headers.forEach(header => {
        const sortInfo = sortColumns.find(sc => sc.column === header);
        const sortIndicator = sortInfo ? (sortInfo.direction === 'asc' ? ' ▲' : ' ▼') : '';
        const hiddenClass = hiddenColumns.has(header) ? 'hidden-column' : '';
        const columnWidth = getColumnWidth(header);
        tableHTML += `<th class="border p-2 bg-gray-100 overflow-hidden sortable ${hiddenClass}" onclick="handleSort('${header}')" style="width: ${columnWidth};">${header}${sortIndicator}</th>`;
    });
    tableHTML += '</tr></thead>';

    // Render body
    tableHTML += '<tbody>';
    filteredAndSortedData.forEach((row, rowIndex) => {
        const rowColor = getRowColor(row);
        tableHTML += `<tr class="${rowColor}">`;
        csvData.headers.forEach(header => {
            let cellContent = row[header] || '';
            if (header === 'APN') {
                cellContent = `<span class="apn-lookup" onclick="copyToClipboard('${cellContent}')">${cellContent}</span>`;
            } else if (header === 'APN Desc.') {
                const description = apnDescriptions[rowIndex] || '';
                cellContent = `<input type="text" value="${description}" onchange="updateAPNDescription(${rowIndex}, this.value)" class="description-input" maxlength="20">`;
            } else if (header === 'Driver') {
                cellContent = `<span class="cursor-pointer hover:underline" onclick="handleDriverClick('${cellContent}', '${row['Route']}')">${cellContent}</span>`;
            } else if (header === 'Reason') {
                cellContent = `<div class="truncate" style="max-width: 100px;">${cellContent}</div>`;
            } else if (header === 'Cust. Name') {
                cellContent = `<div class="truncate" style="max-width: 120px;">${cellContent}</div>`;
            }
            const hiddenClass = hiddenColumns.has(header) ? 'hidden-column' : '';
            tableHTML += `<td class="border p-2 overflow-hidden ${hiddenClass}">${cellContent}</td>`;
        });
        tableHTML += '</tr>';
    });
    tableHTML += '</tbody></table>';

    tableContainer.innerHTML = tableHTML;
    updateRouteCheckboxes();
}

function handlePSVFileUpload(event) {
    console.log("PSV file upload started");
    const file = event.target.files[0];
    if (!file) {
        console.log('No PSV file selected.');
        return;
    }
    if (!file.name.toLowerCase().endsWith('.psv')) {
        alert('Please select a PSV file.');
        event.target.value = ''; // Clear the file input
        return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
        const text = e.target.result;
        processPSVData(text);
        renderTable();
    };
    reader.readAsText(file);
}
// In copyToClipboard function
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

function isLocalDriver(driverName) {
    // Split the driver name into parts
    const parts = driverName.split(',').map(part => part.trim());
    
    // Check if the name exists in the set in both "LastName, FirstName" and "FirstName LastName" formats
    return localDrivers.has(`${parts[0]}, ${parts[1]}`) || localDrivers.has(`${parts[1]} ${parts[0]}`);
}

function updateAPNDescription(rowIndex, description) {
    apnDescriptions[rowIndex] = description;
    renderTable();
}

function toggleControls() {
    const controls = document.getElementById('floatingControls');
    const btn = document.getElementById('toggleControlsBtn');
    controls.classList.toggle('hidden');
    btn.textContent = controls.classList.contains('hidden') ? 'Show' : 'Hide';
}

document.addEventListener('DOMContentLoaded', (event) => {
    const csvFileInput = document.getElementById('csvFileInput');
    const psvFileInput = document.getElementById('psvFileInput');
	document.getElementById('floatingControls').classList.add('hidden');

    csvFileInput.addEventListener('change', handleCSVFileUpload);
    psvFileInput.addEventListener('change', handlePSVFileUpload);

    const fileInputs = document.querySelectorAll('.file-input-wrapper input[type="file"]');
    fileInputs.forEach(input => {
        const button = input.nextElementSibling;
        input.addEventListener('change', function() {
            if (this.files.length > 0) {
                const icon = button.querySelector('i').outerHTML;
                button.innerHTML = `${icon} ${this.files[0].name}`;
            } else {
                const icon = button.querySelector('i').outerHTML;
                button.innerHTML = `${icon} ${this.accept === '.csv' ? 'Choose CSV' : 'Choose PSV'}`;
            }
        });
    });
});
</script>
</body>
</html>
